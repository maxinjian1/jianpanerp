// Japan Omni-EC ERP - Prisma Schema
// Schema-per-Tenant architecture for multi-tenancy

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "tenant"]
}

// ============================================
// PUBLIC SCHEMA - SaaS管理用 (共有)
// ============================================

model Tenant {
  id                   String            @id @default(uuid())
  name                 String
  schemaName           String            @unique
  subscriptionPlan     SubscriptionPlan  @default(STARTER)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               TenantStatus      @default(TRIAL)
  settings             Json              @default("{}")
  trialEndsAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  users User[]

  @@schema("public")
}

model User {
  id           String    @id @default(uuid())
  tenantId     String
  email        String
  passwordHash String
  name         String
  nameKana     String?
  role         UserRole  @default(OPERATOR)
  permissions  Json      @default("[]")
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@index([tenantId])
  @@schema("public")
}

enum SubscriptionPlan {
  STARTER
  GROWTH
  ENTERPRISE

  @@schema("public")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED

  @@schema("public")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  VIEWER

  @@schema("public")
}

// ============================================
// TENANT SCHEMA - 業務データ用 (テナント毎に複製)
// ============================================

// --- Products / MDM ---

model Product {
  id              String        @id @default(uuid())
  sku             String
  janCode         String?
  asin            String?
  rakutenItemCode String?
  name            String
  nameKana        String?
  nameEnglish     String?
  description     String?
  category        String
  subcategory     String?
  brand           String?
  manufacturer    String?
  hasVariants     Boolean       @default(false)
  parentProductId String?
  costPrice       Decimal       @db.Decimal(12, 2)
  wholesalePrice  Decimal?      @db.Decimal(12, 2)
  retailPrice     Decimal       @db.Decimal(12, 2)
  taxRate         Int           @default(10)
  weight          Int           @default(0) // grams
  length          Int?          // mm
  width           Int?          // mm
  height          Int?          // mm
  sizeCode        Int           @default(60)
  reorderPoint    Int           @default(10)
  reorderQuantity Int           @default(50)
  safetyStock     Int           @default(5)
  leadTimeDays    Int           @default(7)
  hasExpiry       Boolean       @default(false)
  expiryWarningDays Int?
  status          ProductStatus @default(ACTIVE)
  isActive        Boolean       @default(true)
  images          Json          @default("[]")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  parentProduct   Product?        @relation("ProductVariants", fields: [parentProductId], references: [id])
  variants        Product[]       @relation("ProductVariants")
  orderItems      OrderItem[]
  inventories     Inventory[]
  bundleComponents BundleComponent[]

  @@unique([sku])
  @@index([janCode])
  @@index([asin])
  @@index([category])
  @@index([status])
  @@schema("tenant")
}

model BundleProduct {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  totalCost   Decimal  @db.Decimal(12, 2)
  retailPrice Decimal  @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  components BundleComponent[]

  @@schema("tenant")
}

model BundleComponent {
  id              String @id @default(uuid())
  bundleProductId String
  productId       String
  quantity        Int

  bundleProduct BundleProduct @relation(fields: [bundleProductId], references: [id])
  product       Product       @relation(fields: [productId], references: [id])

  @@unique([bundleProductId, productId])
  @@schema("tenant")
}

enum ProductStatus {
  ACTIVE
  DISCONTINUED
  OUT_OF_STOCK
  DRAFT

  @@schema("tenant")
}

// --- Orders / OMS ---

model Order {
  id                String        @id @default(uuid())
  platform          Platform
  externalOrderId   String
  externalStatus    String?
  customerName      String        // encrypted
  customerNameKana  String?
  customerEmail     String?       // encrypted
  customerPhone     String        // encrypted
  companyName       String?
  shippingZipCode   String
  shippingPrefecture String
  shippingCity      String
  shippingAddress1  String
  shippingAddress2  String?
  deliveryDate      DateTime?
  deliveryTimeSlot  String?
  subtotal          Decimal       @db.Decimal(12, 2)
  shippingFee       Decimal       @db.Decimal(12, 2) @default(0)
  discount          Decimal       @db.Decimal(12, 2) @default(0)
  taxStandard       Decimal       @db.Decimal(12, 2) @default(0)
  taxReduced        Decimal       @db.Decimal(12, 2) @default(0)
  taxAmount         Decimal       @db.Decimal(12, 2)
  totalAmount       Decimal       @db.Decimal(12, 2)
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus @default(PENDING)
  status            OrderStatus   @default(PENDING)
  assignedCarrier   String?
  trackingNumber    String?
  orderedAt         DateTime
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  cancelledAt       DateTime?
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  items       OrderItem[]
  shipments   Shipment[]
  pickingOrder PickingOrder?

  @@unique([platform, externalOrderId])
  @@index([status])
  @@index([orderedAt])
  @@index([platform])
  @@schema("tenant")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  productId   String?
  sku         String
  janCode     String?
  name        String
  nameKana    String?
  imageUrl    String?
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
  taxRate     Int
  subtotal    Decimal  @db.Decimal(12, 2)
  weight      Int?
  sizeCode    Int?
  lotNumber   String?
  expiryDate  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order   Order    @relation(fields: [orderId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@schema("tenant")
}

enum Platform {
  AMAZON_JP
  RAKUTEN
  YAHOO_SHOPPING
  BASE
  SHOPIFY
  MANUAL

  @@schema("tenant")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  PICKING
  PACKED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  ON_HOLD

  @@schema("tenant")
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED

  @@schema("tenant")
}

enum PaymentMethod {
  CREDIT_CARD
  CONVENIENCE_STORE
  BANK_TRANSFER
  COD
  AMAZON_PAY
  RAKUTEN_PAY
  PAYPAY

  @@schema("tenant")
}

// --- Logistics / TMS ---

model Shipment {
  id                    String         @id @default(uuid())
  orderId               String
  carrier               CarrierCode
  serviceType           String
  trackingNumber        String?
  shippingDate          DateTime?
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?
  totalWeight           Int
  totalSize             Int
  deliveryDate          DateTime?
  deliveryTimeSlot      String?
  status                ShipmentStatus @default(PENDING)
  events                Json           @default("[]")
  shippingCost          Decimal        @db.Decimal(12, 2) @default(0)
  codAmount             Decimal?       @db.Decimal(12, 2)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  order    Order             @relation(fields: [orderId], references: [id])
  packages ShipmentPackage[]

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@schema("tenant")
}

model ShipmentPackage {
  id            String @id @default(uuid())
  shipmentId    String
  packageNumber Int
  weight        Int
  sizeCode      Int
  items         Json   @default("[]")

  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId])
  @@schema("tenant")
}

enum CarrierCode {
  YAMATO
  SAGAWA
  FUKUYAMA
  JAPAN_POST
  SEINO
  NITTSU

  @@schema("tenant")
}

enum ShipmentStatus {
  PENDING
  LABEL_PRINTED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED_DELIVERY
  RETURNED

  @@schema("tenant")
}

model RoutingRule {
  id          String @id @default(uuid())
  name        String
  priority    Int    @default(100)
  conditions  Json   @default("[]")
  carrier     CarrierCode
  serviceType String
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("tenant")
}

// --- Warehouse / WMS ---

model Warehouse {
  id         String   @id @default(uuid())
  name       String
  code       String   @unique
  zipCode    String
  prefecture String
  city       String
  address    String
  phone      String?
  email      String?
  manager    String?
  isDefault  Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  zones       Zone[]
  inventories Inventory[]
  receivings  ReceivingOrder[]
  pickings    PickingOrder[]
  transactions InventoryTransaction[]

  @@schema("tenant")
}

model Zone {
  id          String   @id @default(uuid())
  warehouseId String
  name        String
  code        String
  type        ZoneType @default(STORAGE)

  warehouse Warehouse  @relation(fields: [warehouseId], references: [id])
  locations Location[]

  @@unique([warehouseId, code])
  @@schema("tenant")
}

enum ZoneType {
  RECEIVING
  STORAGE
  PICKING
  PACKING
  SHIPPING
  RETURNS
  COLD

  @@schema("tenant")
}

model Location {
  id         String       @id @default(uuid())
  zoneId     String
  code       String
  type       LocationType @default(SHELF)
  capacity   Int?
  isOccupied Boolean      @default(false)
  isActive   Boolean      @default(true)

  zone        Zone        @relation(fields: [zoneId], references: [id])
  inventories Inventory[]

  @@unique([zoneId, code])
  @@schema("tenant")
}

enum LocationType {
  PALLET
  SHELF
  BIN
  FLOOR

  @@schema("tenant")
}

model Inventory {
  id                String    @id @default(uuid())
  warehouseId       String
  locationId        String?
  productId         String
  quantity          Int       @default(0)
  reservedQty       Int       @default(0)
  lotNumber         String?
  expiryDate        DateTime?
  manufacturingDate DateTime?
  lastReceivedAt    DateTime?
  lastPickedAt      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  location  Location? @relation(fields: [locationId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([warehouseId, productId, lotNumber])
  @@index([productId])
  @@index([expiryDate])
  @@schema("tenant")
}

model InventoryTransaction {
  id            String          @id @default(uuid())
  warehouseId   String
  productId     String
  type          TransactionType
  quantity      Int
  beforeQty     Int
  afterQty      Int
  referenceType String?
  referenceId   String?
  lotNumber     String?
  userId        String
  notes         String?
  createdAt     DateTime        @default(now())

  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([createdAt])
  @@schema("tenant")
}

enum TransactionType {
  RECEIVE
  SHIP
  ADJUST_PLUS
  ADJUST_MINUS
  TRANSFER
  RETURN
  DAMAGED
  EXPIRED

  @@schema("tenant")
}

model ReceivingOrder {
  id              String          @id @default(uuid())
  warehouseId     String
  purchaseOrderId String?
  supplierName    String?
  status          ReceivingStatus @default(PENDING)
  receivedAt      DateTime?
  receivedBy      String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  warehouse Warehouse       @relation(fields: [warehouseId], references: [id])
  items     ReceivingItem[]

  @@index([warehouseId])
  @@index([status])
  @@schema("tenant")
}

model ReceivingItem {
  id               String   @id @default(uuid())
  receivingOrderId String
  productId        String
  expectedQty      Int
  receivedQty      Int      @default(0)
  lotNumber        String?
  expiryDate       DateTime?
  locationId       String?

  receivingOrder ReceivingOrder @relation(fields: [receivingOrderId], references: [id])

  @@index([receivingOrderId])
  @@schema("tenant")
}

enum ReceivingStatus {
  PENDING
  PARTIAL
  COMPLETED
  CANCELLED

  @@schema("tenant")
}

model PickingOrder {
  id          String         @id @default(uuid())
  warehouseId String
  orderId     String         @unique
  status      PickingStatus  @default(PENDING)
  priority    PickingPriority @default(NORMAL)
  assignedTo  String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  warehouse Warehouse     @relation(fields: [warehouseId], references: [id])
  order     Order         @relation(fields: [orderId], references: [id])
  items     PickingItem[]

  @@index([warehouseId])
  @@index([status])
  @@schema("tenant")
}

model PickingItem {
  id             String            @id @default(uuid())
  pickingOrderId String
  productId      String
  locationId     String
  requiredQty    Int
  pickedQty      Int               @default(0)
  lotNumber      String?
  status         PickingItemStatus @default(PENDING)

  pickingOrder PickingOrder @relation(fields: [pickingOrderId], references: [id])

  @@index([pickingOrderId])
  @@schema("tenant")
}

enum PickingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("tenant")
}

enum PickingPriority {
  URGENT
  HIGH
  NORMAL
  LOW

  @@schema("tenant")
}

enum PickingItemStatus {
  PENDING
  PICKED
  SHORT
  SKIPPED

  @@schema("tenant")
}

// --- Marketplace Credentials ---

model MarketplaceCredential {
  id            String   @id @default(uuid())
  platform      Platform
  name          String
  refreshToken  String   // encrypted
  accessToken   String?  // encrypted
  tokenExpiresAt DateTime?
  sellerId      String?
  marketplaceId String?
  isActive      Boolean  @default(true)
  lastSyncAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([platform, sellerId])
  @@schema("tenant")
}

// --- AI / Forecasting ---

model ForecastResult {
  id           String   @id @default(uuid())
  productId    String
  sku          String
  forecastDate DateTime
  predictions  Json     @default("[]")
  metrics      Json     @default("{}")
  modelUsed    String
  confidence   Float
  createdAt    DateTime @default(now())

  @@index([productId])
  @@index([forecastDate])
  @@schema("tenant")
}

model RestockSuggestion {
  id                  String           @id @default(uuid())
  productId           String
  sku                 String
  productName         String
  currentStock        Int
  forecastedDemand    Int
  daysUntilStockout   Int
  suggestedOrderQty   Int
  suggestedOrderDate  DateTime
  urgency             RestockUrgency
  estimatedCost       Decimal          @db.Decimal(12, 2)
  potentialLostSales  Decimal          @db.Decimal(12, 2)
  status              SuggestionStatus @default(PENDING)
  approvedBy          String?
  approvedAt          DateTime?
  generatedAt         DateTime         @default(now())

  @@index([productId])
  @@index([urgency])
  @@index([status])
  @@schema("tenant")
}

enum RestockUrgency {
  CRITICAL
  HIGH
  MEDIUM
  LOW

  @@schema("tenant")
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  ORDERED
  EXPIRED

  @@schema("tenant")
}

// --- Audit & Notifications ---

model AuditLog {
  id            String   @id @default(uuid())
  userId        String
  action        String
  entityType    String
  entityId      String
  previousValue Json?
  newValue      Json?
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@schema("tenant")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String?
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@schema("tenant")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  ORDER_NEW
  ORDER_SHIPPED
  INVENTORY_LOW
  RESTOCK_SUGGESTION

  @@schema("tenant")
}

